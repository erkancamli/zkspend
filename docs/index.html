<!doctype html>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>zkSpend – Galileo Testnet</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; margin:24px; line-height:1.5;}
  .card{border:1px solid #e5e7eb; border-radius:14px; padding:16px; margin:12px 0; box-shadow:0 1px 2px rgba(0,0,0,.04);}
  code,kbd{background:#f6f8fa; padding:2px 6px; border-radius:6px}
  .muted{color:#6b7280}
  button{border:1px solid #e5e7eb; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer}
  button:disabled{opacity:.6; cursor:not-allowed}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>

<h1>zkSpend – Private Receipt → On-Chain Reward</h1>

<div class="card">
  <div class="row">
    <div>
      <div><b>Factory</b>:</div>
      <div class="mono">0x8712b078774df0988bC89f7939154E0D72fCf6f2</div>
    </div>
    <div>
      <div><b>Campaign (0.1 ETH)</b>:</div>
      <div class="mono">0x8bbac06bd634f12250079fd1470c2016157f6bd8</div>
    </div>
    <div>
      <div><b>Campaign (0.002 ETH)</b>:</div>
      <div class="mono" id="camp">0xd35116e3984b9e7564079750ab726aa4c1d7e77d</div>
    </div>
  </div>
  <p class="muted">Ağ: 0G Galileo Testnet (chainId 16601) · RPC: <span class="mono">https://evmrpc-testnet.0g.ai</span></p>
</div>

<div class="card">
  <h3>Durum</h3>
  <div>Campaign bakiye: <b><span id="bal">–</span></b></div>
  <div>Son 10 claim:</div>
  <ul id="claims" class="mono"></ul>
  <div style="margin-top:8px">
    <button id="refresh">Yenile</button>
  </div>
</div>

<div class="card">
  <h3>Tek tık claim (terminal)</h3>
  <ol>
    <li><code>source ~/zkspend/scripts/env.local</code></li>
    <li><code>export CAMPAIGN=0xd35116e3984b9e7564079750ab726aa4c1d7e77d</code></li>
    <li><code>export FROM=&lt;senin_adresin&gt;</code></li>
    <li><code>~/zkspend/scripts/claim_once.sh ~/zkspend/receipts/receipt_3.png</code></li>
  </ol>
</div>

<p class="muted">Event: <code>Claimed(address,bytes32,bytes32)</code></p>

<script>
const RPC = "https://evmrpc-testnet.0g.ai";
const CAMPAIGN = document.getElementById('camp').textContent.trim();
// Event signature (topics[0]) – zincir logundan alınmış sabit:
const CLAIMED_SIG = "0xcbcb845d94d59960a0c6e8b3a1f47ad81bb57269de43e89ff4f0fa656246f5f6";

async function rpc(method, params){
  const r = await fetch(RPC, {
    method:"POST",
    headers: {"content-type":"application/json"},
    body: JSON.stringify({jsonrpc:"2.0", id:1, method, params})
  });
  const j = await r.json();
  if(j.error) throw new Error(j.error.message);
  return j.result;
}

function weiToEth(wei){
  if(!wei) return "0";
  const n = BigInt(wei);
  const eth = Number(n) / 1e18;
  return eth.toString();
}

async function load(){
  document.getElementById('refresh').disabled = true;

  // Bakiye
  const balWei = await rpc("eth_getBalance", [CAMPAIGN, "latest"]);
  document.getElementById('bal').textContent = weiToEth(balWei) + " ETH";

  // Son 10 Claim logu
  const latest = await rpc("eth_blockNumber", []);
  const latestNum = parseInt(latest, 16);
  const from = Math.max(latestNum - 100000, 0); // geniş bir aralık
  const logs = await rpc("eth_getLogs", [{
    address: CAMPAIGN,
    fromBlock: "0x" + from.toString(16),
    toBlock: latest,
    topics: [CLAIMED_SIG]
  }]);

  const ul = document.getElementById('claims');
  ul.innerHTML = "";
  logs.slice(-10).reverse().forEach(l => {
    // data = RC (32) + NUL (32)
    const hex = l.data.startsWith("0x") ? l.data.slice(2) : l.data;
    const rc  = "0x" + hex.slice(0, 64);
    const nul = "0x" + hex.slice(64, 128);
    const li = document.createElement('li');
    li.innerHTML = `tx=<a href="https://evm-testnet.0g.ai/tx/${l.transactionHash}" target="_blank">${l.transactionHash.slice(0,10)}…</a> · RC=${rc.slice(0,10)}… · NUL=${nul.slice(0,10)}…`;
    ul.appendChild(li);
  });

  document.getElementById('refresh').disabled = false;
}

document.getElementById('refresh').onclick = load;
load();
</script>
