<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>zkSpend – TX Viewer (0G Galileo)</title>
<style>
  :root{--fg:#0b1320;--mut:#64748b}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;max-width:980px;margin:32px auto;padding:0 16px;color:var(--fg)}
  header{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
  input,button{font:inherit;padding:10px 12px;border:1px solid #d0d7de;border-radius:10px}
  input{min-width:320px}
  button{cursor:pointer}
  h1{margin:0 0 10px}
  .mut{color:var(--mut);font-size:14px}
  code{background:#f6f8fa;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px}
  pre{background:#0b1320;color:#cbd5e1;padding:14px;border-radius:12px;overflow:auto}
  ul{margin:6px 0 14px}
  li{margin:4px 0}
  .lock{font-size:12px;padding:4px 6px;border-radius:6px;background:#eef2ff;border:1px solid #c7d2fe}
</style>

<h1>Tx Receipt</h1>
<header>
  <span class="mut">RPC:</span>
  <input id="rpc" readonly>
  <span class="lock" title="RPC sabit. İstersen URL'e ?rpc= yazıp geçici override edebilirsin.">locked</span>
  <span class="mut">Tx:</span>
  <input id="tx" placeholder="0x...">
  <button id="load">Load</button>
</header>

<div id="summary" class="mut">Hazır.</div>
<pre id="json"></pre>

<script>
/* ---- RPC sabitleme ---- */
const DEFAULT_RPC = 'https://evmrpc-testnet.0g.ai'; // public 0G Galileo RPC
// İstersen sadece kendi tarayıcında geçici override: URL'e ?rpc=<url> ekle
const params = new URLSearchParams(location.search);
let rpcUrl = params.get('rpc') || DEFAULT_RPC;
document.getElementById('rpc').value = rpcUrl;

const $tx  = document.getElementById('tx');
$tx.value  = params.get('tx') || '';

const CLAIMED_SIG = '0xcbcb845d94d59960a0c6e8b3a1f47ad81bb57269de43e89ff4f0fa656246f5f6';

function hexToNum(h){ return parseInt(h,16); }
function hexToBig(h){ return BigInt(h); }
function gwei(n){ return Number(n)/1e9; }
function weiToEth(w){ return Number(w)/1e18; }

async function call(method, args){
  const r = await fetch(rpcUrl, {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({jsonrpc:'2.0', id:1, method, params: args})
  });
  const j = await r.json();
  if (j.error) throw new Error(j.error.message);
  return j.result;
}

async function load(){
  try{
    const summary = document.getElementById('summary');
    summary.textContent = 'Yükleniyor...';
    const txHash  = $tx.value.trim();
    if(!txHash){ summary.textContent = 'Tx gir.'; return; }

    const [rcpt, tx] = await Promise.all([
      call('eth_getTransactionReceipt',[txHash]),
      call('eth_getTransactionByHash', [txHash]),
    ]);
    const block = await call('eth_getBlockByHash',[rcpt.blockHash, false]);

    const gasUsed  = hexToBig(rcpt.gasUsed);
    const gasPrice = tx.type==='0x0' ? hexToBig(tx.gasPrice) : hexToBig(rcpt.effectiveGasPrice || '0x0');
    const feeEth   = weiToEth(gasUsed * gasPrice);
    const when     = new Date(hexToNum(block.timestamp)*1000).toLocaleString();

    let html = `
      <h3>${rcpt.status==='0x1' ? '✅ Success' : '❌ Failed'}</h3>
      <ul>
        <li>RPC: <code>${rpcUrl}</code></li>
        <li>Block: <b>${hexToNum(rcpt.blockNumber)}</b> <span class="mut">(${when})</span></li>
        <li>From: <code>${tx.from}</code></li>
        <li>To: <code>${rcpt.to || '(contract creation)'}</code></li>
        <li>Gas used: <b>${gasUsed.toString()}</b> @ <b>${gwei(gasPrice).toFixed(2)} gwei</b> → fee ≈ <b>${feeEth.toFixed(6)} ETH</b></li>
      </ul>
    `;

    const claims = (rcpt.logs||[]).filter(l => l.topics[0]===CLAIMED_SIG);
    if (claims.length){
      html += `<h3>Claimed events (${claims.length})</h3><ol>`;
      for(const l of claims){
        const hex = l.data.startsWith('0x') ? l.data.slice(2) : l.data;
        const rc  = '0x' + hex.slice(0,64);
        const nul = '0x' + hex.slice(64,128);
        const user= '0x' + l.topics[1].slice(26);
        html += `<li>contract <code>${l.address}</code> · user <code>${user}</code><br>
                 RC <code>${rc}</code><br>NUL <code>${nul}</code></li>`;
      }
      html += `</ol>`;
    } else {
      html += `<p class="mut">Claimed logu yok.</p>`;
    }

    summary.innerHTML = html;
    document.getElementById('json').textContent  = JSON.stringify({receipt: rcpt, tx, block}, null, 2);

    const u = new URL(location);
    u.searchParams.set('tx', txHash);
    if (params.get('rpc')) u.searchParams.set('rpc', rpcUrl); // sadece override varsa yaz
    history.replaceState(null,'',u);
  } catch(e){
    document.getElementById('summary').innerHTML = `<b>Hata:</b> ${e.message}`;
  }
}

document.getElementById('load').onclick = (ev)=>{ ev.preventDefault(); load(); };
if ($tx.value) load();
</script>
</html>
